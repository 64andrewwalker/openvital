name: Jules Scheduled Tasks

on:
  schedule:
    - cron: '0 2 * * *'    # Daily: bug-hunter at 2:00 UTC
    - cron: '30 2 * * *'   # Daily: security-patrol at 2:30 UTC
    - cron: '0 3 * * 1'    # Weekly Mon: test-coverage at 3:00 UTC
    - cron: '0 3 * * 3'    # Weekly Wed: dependency-health at 3:00 UTC
    - cron: '0 3 * * 5'    # Weekly Fri: doc-consistency at 3:00 UTC
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to run manually'
        required: true
        type: choice
        options:
          - bug-hunter
          - security-patrol
          - test-coverage
          - dependency-health
          - doc-consistency

permissions:
  contents: read
  issues: write

env:
  JULES_API_URL: https://jules.googleapis.com/v1alpha
  JULES_SOURCE: sources/github/64andrewwalker/openvital

jobs:
  bug-hunter:
    if: github.event.schedule == '0 2 * * *' || github.event.inputs.task == 'bug-hunter'
    concurrency:
      group: jules-scheduled-bug-hunter
      cancel-in-progress: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run bug-hunter
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          source .github/jules-prompts/helpers.sh
          jules_create_session \
            .github/jules-prompts/bug-hunter.txt \
            "[jules-bug] Scheduled bug hunt" \
            "master"
      - name: Create jules-error issue on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TITLE="[jules-error] bug-hunter failed"
          EXISTING=$(gh issue list --label "jules-error" --state open \
            --json title --jq ".[] | select(.title == \"$TITLE\") | .title" | head -1)
          if [[ -z "$EXISTING" ]]; then
            gh issue create \
              --title "$TITLE" \
              --body "The bug-hunter scheduled task failed. [View run](${RUN_URL})" \
              --label "jules-error"
          fi

  security-patrol:
    if: github.event.schedule == '30 2 * * *' || github.event.inputs.task == 'security-patrol'
    concurrency:
      group: jules-scheduled-security-patrol
      cancel-in-progress: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run security-patrol
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          source .github/jules-prompts/helpers.sh
          jules_create_session \
            .github/jules-prompts/security-patrol.txt \
            "[jules-security] Scheduled security patrol" \
            "master"
      - name: Create jules-error issue on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TITLE="[jules-error] security-patrol failed"
          EXISTING=$(gh issue list --label "jules-error" --state open \
            --json title --jq ".[] | select(.title == \"$TITLE\") | .title" | head -1)
          if [[ -z "$EXISTING" ]]; then
            gh issue create \
              --title "$TITLE" \
              --body "The security-patrol scheduled task failed. [View run](${RUN_URL})" \
              --label "jules-error"
          fi

  test-coverage:
    if: github.event.schedule == '0 3 * * 1' || github.event.inputs.task == 'test-coverage'
    concurrency:
      group: jules-scheduled-test-coverage
      cancel-in-progress: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run test-coverage
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          source .github/jules-prompts/helpers.sh
          jules_create_session \
            .github/jules-prompts/test-coverage.txt \
            "[jules-test] Scheduled test coverage" \
            "master"
      - name: Create jules-error issue on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TITLE="[jules-error] test-coverage failed"
          EXISTING=$(gh issue list --label "jules-error" --state open \
            --json title --jq ".[] | select(.title == \"$TITLE\") | .title" | head -1)
          if [[ -z "$EXISTING" ]]; then
            gh issue create \
              --title "$TITLE" \
              --body "The test-coverage scheduled task failed. [View run](${RUN_URL})" \
              --label "jules-error"
          fi

  dependency-health:
    if: github.event.schedule == '0 3 * * 3' || github.event.inputs.task == 'dependency-health'
    concurrency:
      group: jules-scheduled-dependency-health
      cancel-in-progress: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run dependency-health
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          source .github/jules-prompts/helpers.sh
          jules_create_session \
            .github/jules-prompts/dependency-health.txt \
            "[jules-deps] Scheduled dependency health check" \
            "master"
      - name: Create jules-error issue on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TITLE="[jules-error] dependency-health failed"
          EXISTING=$(gh issue list --label "jules-error" --state open \
            --json title --jq ".[] | select(.title == \"$TITLE\") | .title" | head -1)
          if [[ -z "$EXISTING" ]]; then
            gh issue create \
              --title "$TITLE" \
              --body "The dependency-health scheduled task failed. [View run](${RUN_URL})" \
              --label "jules-error"
          fi

  doc-consistency:
    if: github.event.schedule == '0 3 * * 5' || github.event.inputs.task == 'doc-consistency'
    concurrency:
      group: jules-scheduled-doc-consistency
      cancel-in-progress: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run doc-consistency
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          source .github/jules-prompts/helpers.sh
          jules_create_session \
            .github/jules-prompts/doc-consistency.txt \
            "[jules-docs] Scheduled doc consistency check" \
            "master"
      - name: Create jules-error issue on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TITLE="[jules-error] doc-consistency failed"
          EXISTING=$(gh issue list --label "jules-error" --state open \
            --json title --jq ".[] | select(.title == \"$TITLE\") | .title" | head -1)
          if [[ -z "$EXISTING" ]]; then
            gh issue create \
              --title "$TITLE" \
              --body "The doc-consistency scheduled task failed. [View run](${RUN_URL})" \
              --label "jules-error"
          fi
